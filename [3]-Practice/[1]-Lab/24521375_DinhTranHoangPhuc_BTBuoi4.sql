DROP DATABASE QUANLYBAOHIEM
CREATE DATABASE QUANLYBAOHIEM
USE QUANLYBAOHIEM
--  ########## Lenh DROP ##########
DROP TABLE KHACHHANG;
DROP TABLE LOAIBAOHIEM;
DROP TABLE HOPDONG;
DROP TABLE CHITIETHD;
DROP TABLE LSDONGTIEN;
DROP TABLE YEUCAUBAOHIEM;

-- ########## Khoi tao bang (chua khai bao khoa chinh + rang buoc khoa ngoai) ##########
CREATE TABLE KHACHHANG (
    MaKH NVARCHAR(5) NOT NULL,
    HoTen NVARCHAR(40),
    NgSinh SMALLDATETIME,
    CCCD VARCHAR(12),
    NgheNghiep NVARCHAR(20)
);

CREATE TABLE LOAIBAOHIEM (
    MaLBH NVARCHAR(6) NOT NULL,
    TenLBH NVARCHAR(20),
    STBaoHiem MONEY,
    STDongDinhKy MONEY,
    KyThanhToan NVARCHAR(15)
);

CREATE TABLE HOPDONG (
    SoHD NVARCHAR(6) NOT NULL,
    MaKHDaiDien NVARCHAR(5),
    NgKyHD SMALLDATETIME,
    NgHieuLuc SMALLDATETIME,
    NgHetHan SMALLDATETIME,
    TriGia MONEY
);

CREATE TABLE CHITIETHD (
    MaCTHD NVARCHAR(6) NOT NULL,
    SoHD NVARCHAR(6),
    MaKHThuHuong NVARCHAR(5),
    MaLBH NVARCHAR(6)
);

CREATE TABLE LSDONGTIEN (
    MaGD NVARCHAR(6) NOT NULL,
    MaCTHD NVARCHAR(6),
    NgDongTien SMALLDATETIME,
    STDong MONEY,
    PhuongThuc NVARCHAR(15)
);

CREATE TABLE YEUCAUBAOHIEM (
    MaYC NVARCHAR(6) NOT NULL,
    MaCTHD NVARCHAR(6),
    STYeuCau MONEY,
    STDuyetChi MONEY,
    NgYeuCau SMALLDATETIME,
    TrangThai NVARCHAR(15)
);

-- ########## Them khoa chinh + rang buoc khoa ngoai ##########
ALTER TABLE KHACHHANG
ADD CONSTRAINT PK_KHACHHANG PRIMARY KEY (MaKH);

ALTER TABLE LOAIBAOHIEM 
ADD CONSTRAINT PK_LOAIBAOHIEM PRIMARY KEY (MaLBH);

ALTER TABLE HOPDONG
ADD CONSTRAINT PK_HOPDONG PRIMARY KEY (SoHD);

ALTER TABLE CHITIETHD
ADD CONSTRAINT PK_CHITIETHD PRIMARY KEY (MaCTHD);

ALTER TABLE LSDONGTIEN
ADD CONSTRAINT PK_LSDONGTIEN PRIMARY KEY (MaGD);

ALTER TABLE YEUCAUBAOHIEM
ADD CONSTRAINT PK_YEUCAUBAOHIEM PRIMARY KEY (MaYC);

ALTER TABLE HOPDONG
ADD CONSTRAINT FK_HOPDONG_KHDAIDIEN FOREIGN KEY (MaKHDaiDien) REFERENCES KHACHHANG(MaKH);

ALTER TABLE CHITIETHD
ADD CONSTRAINT FK_CTHD_HOPDONG FOREIGN KEY (SoHD) REFERENCES HOPDONG(SoHD);
ALTER TABLE CHITIETHD
ADD CONSTRAINT FK_CTHD_KHTHUHUONG FOREIGN KEY (MaKHThuHuong) REFERENCES KHACHHANG(MaKH);

ALTER TABLE LSDONGTIEN
ADD CONSTRAINT FK_LSDT_CTHD FOREIGN KEY (MaCTHD) REFERENCES CHITIETHD(MaCTHD);
ALTER TABLE LSDONGTIEN
ADD CONSTRAINT FK_LSDT_ FOREIGN KEY (MaCTHD) REFERENCES CHITIETHD(MaCTHD);

ALTER TABLE YEUCAUBAOHIEM 
ADD CONSTRAINT FK_YCBH_MaCTHD FOREIGN KEY (MaCTHD) REFERENCES CHITIETHD(MaCTHD);

SET DATEFORMAT DMY;

-- ########## Them du lieu vao bang ##########
INSERT INTO KHACHHANG VALUES ('KH001', N'Nguyễn Văn A', '01/01/1985', '012345678901', N'Nhân viên');
INSERT INTO KHACHHANG VALUES ('KH002', N'Trần Thị B', '10/02/1990', '012345678902', N'Kỹ sư');
INSERT INTO KHACHHANG VALUES ('KH003', N'Lê Văn C', '15/03/1988', '012345678903', N'Giáo viên');
INSERT INTO KHACHHANG VALUES ('KH004', N'Phạm Thị D', '20/04/1992', '012345678904', N'Kiểm toán');
INSERT INTO KHACHHANG VALUES ('KH005', N'Hoàng Văn E', '05/05/1984', '012345678905', N'Công nhân');
INSERT INTO KHACHHANG VALUES ('KH006', N'Võ Thị F', '12/06/1995', '012345678906', N'Nhân viên văn phòng');
INSERT INTO KHACHHANG VALUES ('KH007', N'Phan Văn G', '30/07/1989', '012345678907', N'Quản lý');
INSERT INTO KHACHHANG VALUES ('KH008', N'Nguyễn Thị H', '25/08/1993', '012345678908', N'Tự do');
INSERT INTO KHACHHANG VALUES ('KH009', N'Bùi Văn I', '14/09/1987', '012345678909', N'Kỹ thuật');
INSERT INTO KHACHHANG VALUES ('KH010', N'Đỗ Thị K', '02/10/1991', '012345678910', N'Kinh doanh');
INSERT INTO KHACHHANG VALUES ('KH011', N'Nguyễn Văn M', '10/10/1985', '012345678911', N'Giáo viên');
INSERT INTO KHACHHANG VALUES ('KH012', N'Trần Thị N', '15/05/1990', '012345678912', N'Giáo viên');
INSERT INTO KHACHHANG VALUES ('KH013', N'Lê Văn O', '22/03/1988', '012345678913', N'Giáo viên');
INSERT INTO KHACHHANG VALUES ('KH021', N'Nguyễn Văn P', '10/02/1985', '012345678921', N'Nhân viên');
INSERT INTO KHACHHANG VALUES ('KH022', N'Trần Thị Q', '15/03/1987', '012345678922', N'Tự do');
INSERT INTO KHACHHANG VALUES ('KH023', N'Lê Văn R',  '20/04/1990', '012345678923', N'Kiểm toán');
INSERT INTO KHACHHANG VALUES ('KH024', N'Phạm Thị S','25/06/1992', '012345678924', N'Kỹ sư');
INSERT INTO KHACHHANG VALUES ('KH025', N'Hoàng Văn T','12/08/1988', '012345678925', N'Giáo viên');
INSERT INTO KHACHHANG VALUES ('KH031', N'Nguyễn Thái U', '12/02/1986', '012345678931', N'Kỹ sư');
INSERT INTO KHACHHANG VALUES ('KH032', N'Lê Thị V', '18/07/1991', '012345678932', N'Nhân viên');
INSERT INTO KHACHHANG VALUES ('KH041', N'Nguyễn Văn X', '10/10/1986', '012345678941', N'Kỹ sư');
INSERT INTO KHACHHANG VALUES ('KH042', N'Lê Thị Y', '12/12/1990', '012345678942', N'Nhân viên');

INSERT INTO LOAIBAOHIEM VALUES ('LB001', N'Sinh kỳ', 100000000, 1000000, N'Hàng tháng');
INSERT INTO LOAIBAOHIEM VALUES ('LB002', N'Tử kỳ', 80000000, 800000, N'Hàng tháng');
INSERT INTO LOAIBAOHIEM VALUES ('LB003', N'Sức khỏe', 50000000, 600000, N'Hàng quý');
INSERT INTO LOAIBAOHIEM VALUES ('LB004', N'Tai nạn', 30000000, 300000, N'Hàng quý');
INSERT INTO LOAIBAOHIEM VALUES ('LB005', N'Nhà tư', 150000000, 1500000, N'Hàng năm');
INSERT INTO LOAIBAOHIEM VALUES ('LB006', N'Ung thư', 200000000, 1200000, N'Hàng năm');
INSERT INTO LOAIBAOHIEM VALUES ('LB007', N'Dinh dưỡng', 40000000, 400000, N'Hàng tháng');
INSERT INTO LOAIBAOHIEM VALUES ('LB008', N'Hưu trí', 250000000, 2000000, N'Hàng năm');
INSERT INTO LOAIBAOHIEM VALUES ('LB009', N'Trẻ em', 30000000, 250000, N'Hàng quý');
INSERT INTO LOAIBAOHIEM VALUES ('LB010', N'Thai sản', 70000000, 700000, N'Hàng tháng');

INSERT INTO HOPDONG VALUES ('HD001', 'KH001', '01/01/2020', '05/01/2020', '05/01/2030', 100000000);
INSERT INTO HOPDONG VALUES ('HD002', 'KH002', '01/02/2020', '05/02/2020', '05/02/2030', 80000000);
INSERT INTO HOPDONG VALUES ('HD003', 'KH003', '01/03/2020', '05/03/2020', '05/03/2030', 50000000);
INSERT INTO HOPDONG VALUES ('HD004', 'KH004', '01/04/2020', '05/04/2020', '05/04/2030', 60000000);
INSERT INTO HOPDONG VALUES ('HD005', 'KH005', '01/05/2020', '05/05/2020', '05/05/2030', 70000000);
INSERT INTO HOPDONG VALUES ('HD006', 'KH006', '01/06/2020', '05/06/2020', '05/06/2030', 90000000);
INSERT INTO HOPDONG VALUES ('HD007', 'KH007', '01/07/2020', '05/07/2020', '05/07/2030', 110000000);
INSERT INTO HOPDONG VALUES ('HD008', 'KH008', '01/08/2020', '05/08/2020', '05/08/2030', 150000000);
INSERT INTO HOPDONG VALUES ('HD009', 'KH009', '01/09/2020', '05/09/2020', '05/09/2030', 130000000);
INSERT INTO HOPDONG VALUES ('HD010', 'KH010', '01/10/2020', '05/10/2020', '05/10/2030', 140000000);
INSERT INTO HOPDONG VALUES ('HD011', 'KH011', '01/01/2021', '05/01/2021', '30/12/2025', 60000000);
INSERT INTO HOPDONG VALUES ('HD012', 'KH012', '01/02/2021', '05/02/2021', '15/08/2024', 55000000);
INSERT INTO HOPDONG VALUES ('HD013', 'KH013', '01/03/2021', '05/03/2021', '10/09/2023', 50000000);
INSERT INTO HOPDONG VALUES ('HD021', 'KH021', '05/01/2025', '10/01/2025', '10/01/2035', 120000000);
INSERT INTO HOPDONG VALUES ('HD022', 'KH022', '12/02/2025', '15/02/2025', '15/02/2035', 150000000);
INSERT INTO HOPDONG VALUES ('HD023', 'KH023', '20/03/2025', '25/03/2025', '25/03/2035', 170000000);
INSERT INTO HOPDONG VALUES ('HD024', 'KH024', '30/04/2025', '05/05/2025', '05/05/2035', 200000000);
INSERT INTO HOPDONG VALUES ('HD025', 'KH025', '12/06/2025', '15/06/2025', '15/06/2035', 250000000);
INSERT INTO HOPDONG VALUES ('HD031', 'KH031', '01/01/2024', '05/01/2024', '05/01/2034', 90000000);
INSERT INTO HOPDONG VALUES ('HD032', 'KH032', '15/03/2024', '20/03/2024', '20/03/2034', 85000000);
INSERT INTO HOPDONG VALUES ('HD041', 'KH041', '01/01/2024', '05/01/2024', '05/01/2034', 90000000);
INSERT INTO HOPDONG VALUES ('HD042', 'KH042', '15/03/2024', '20/03/2024', '20/03/2034', 85000000);

INSERT INTO CHITIETHD VALUES ('CT001', 'HD001', 'KH001', 'LB001');
INSERT INTO CHITIETHD VALUES ('CT002', 'HD002', 'KH002', 'LB002');
INSERT INTO CHITIETHD VALUES ('CT003', 'HD003', 'KH003', 'LB003');
INSERT INTO CHITIETHD VALUES ('CT004', 'HD004', 'KH004', 'LB004');
INSERT INTO CHITIETHD VALUES ('CT005', 'HD005', 'KH005', 'LB005');
INSERT INTO CHITIETHD VALUES ('CT006', 'HD006', 'KH006', 'LB006');
INSERT INTO CHITIETHD VALUES ('CT007', 'HD007', 'KH007', 'LB007');
INSERT INTO CHITIETHD VALUES ('CT008', 'HD008', 'KH008', 'LB008');
INSERT INTO CHITIETHD VALUES ('CT009', 'HD009', 'KH009', 'LB009');
INSERT INTO CHITIETHD VALUES ('CT010', 'HD010', 'KH010', 'LB010');
INSERT INTO CHITIETHD VALUES ('CT011', 'HD011', 'KH011', 'LB001');
INSERT INTO CHITIETHD VALUES ('CT012', 'HD012', 'KH012', 'LB002');
INSERT INTO CHITIETHD VALUES ('CT013', 'HD013', 'KH013', 'LB003');
INSERT INTO CHITIETHD VALUES ('CT021A', 'HD021', 'KH021', 'LB011');
INSERT INTO CHITIETHD VALUES ('CT021B', 'HD021', 'KH021', 'LB012');
INSERT INTO CHITIETHD VALUES ('CT022A', 'HD022', 'KH022', 'LB011');
INSERT INTO CHITIETHD VALUES ('CT022B', 'HD022', 'KH022', 'LB012');
INSERT INTO CHITIETHD VALUES ('CT023A', 'HD023', 'KH023', 'LB011');
INSERT INTO CHITIETHD VALUES ('CT023B', 'HD023', 'KH023', 'LB012');
INSERT INTO CHITIETHD VALUES ('CT024A', 'HD024', 'KH024', 'LB011');
INSERT INTO CHITIETHD VALUES ('CT024B', 'HD024', 'KH024', 'LB012');
INSERT INTO CHITIETHD VALUES ('CT025A', 'HD025', 'KH025', 'LB011');
INSERT INTO CHITIETHD VALUES ('CT025B', 'HD025', 'KH025', 'LB012');
INSERT INTO CHITIETHD VALUES ('CT031A', 'HD031', 'KH031', 'LB001');
INSERT INTO CHITIETHD VALUES ('CT031B', 'HD031', 'KH031', 'LB010'); 
INSERT INTO CHITIETHD VALUES ('CT032A', 'HD032', 'KH032', 'LB002'); 
INSERT INTO CHITIETHD VALUES ('CT032B', 'HD032', 'KH032', 'LB007');
INSERT INTO CHITIETHD VALUES ('CT041A', 'HD041', 'KH041', 'LB001');
INSERT INTO CHITIETHD VALUES ('CT042A', 'HD042', 'KH042', 'LB001');

INSERT INTO LSDONGTIEN VALUES ('GD001', 'CT001', '01/02/2020', 1000000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD002', 'CT002', '01/03/2020', 800000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD003', 'CT003', '01/04/2020', 600000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD004', 'CT004', '01/05/2020', 300000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD005', 'CT005', '01/06/2020', 1500000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD006', 'CT006', '01/07/2020', 1200000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD007', 'CT007', '01/08/2020', 400000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD008', 'CT008', '01/09/2020', 2000000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD009', 'CT009', '01/10/2020', 250000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD010', 'CT010', '01/11/2020', 700000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD011', 'CT003', '05/11/2025', 2500000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD012', 'CT007', '20/11/2025', 3500000, N'Tiền mặt');
INSERT INTO LSDONGTIEN VALUES ('GD0411', 'CT041A', '10/01/2025', 1000000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0412', 'CT041A', '10/02/2025', 1000000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0413', 'CT041A', '10/03/2025', 1000000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0414', 'CT041A', '10/04/2025', 1000000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0421', 'CT042A', '15/01/2025', 900000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0422', 'CT042A', '15/02/2025', 900000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0423', 'CT042A', '15/03/2025', 900000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0424', 'CT042A', '15/04/2025', 900000, N'Chuyển khoản');
INSERT INTO LSDONGTIEN VALUES ('GD0425', 'CT042A', '15/05/2025', 900000, N'Tiền mặt');

INSERT INTO YEUCAUBAOHIEM VALUES ('YC001', 'CT001', 5000000, 4000000, '01/01/2025', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC002', 'CT002', 3000000, 2000000, '01/02/2025', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC003', 'CT003', 2000000, 1500000, '01/03/2025', N'Đang xét duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC004', 'CT004', 1000000, 800000, '01/04/2025', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC005', 'CT005', 8000000, 6000000, '01/05/2025', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC006', 'CT006', 7000000, 5000000, '01/06/2025', N'Từ chối');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC007', 'CT007', 1500000, 1000000, '01/07/2024', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC008', 'CT008', 12000000, 9000000, '01/08/2024', N'Đang xét duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC009', 'CT009', 2000000, 2000000, '01/09/2024', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC010', 'CT010', 5000000, 4500000, '01/10/2024', N'Đã duyệt');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC031A', 'CT031A', 5000000, 5000000, '05/02/2025', N'Đã chi trả');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC031B', 'CT031B', 3000000, 3000000, '10/03/2025', N'Đã chi trả');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC032A', 'CT032A', 4000000, 4000000, '15/04/2025', N'Đã chi trả');
INSERT INTO YEUCAUBAOHIEM VALUES ('YC032B', 'CT032B', 2500000, 2500000, '20/05/2025', N'Đã chi trả');
-- ########## DDL, DML ##########
-- 1a. Tạo ràng buộc sau: Ngày hợp đồng có hiệu lực phải lớn hơn ngày ký hợp đồng và nhỏ hơn ngày hết hạn của hợp đồng. 
ALTER TABLE HOPDONG
ADD CONSTRAINT CK_HOPDONG_NGAY 
CHECK (NgHieuLuc > NgKyHD AND NgHieuLuc < NgHetHan);

-- 1b. Tạo ràng buộc sau: Khách hàng thụ hưởng của một chi tiết hợp đồng cũng là một khách hàng.  
ALTER TABLE CHITIETHD
ADD CONSTRAINT FK_CTHD_KHTHUHUONG FOREIGN KEY (MaKHThuHuong) REFERENCES KHACHHANG(MaKH);

-- 1c. Cập nhật tăng 15% số tiền bảo hiểm tối đa và số tiền đóng định kỳ đối với loại bảo hiểm có tên là ‘Bảo hiểm sức khỏe nội trú’.  
ALTER TABLE LOAIBAOHIEM
ALTER COLUMN TenLBH NVARCHAR(30) NULL;

UPDATE LOAIBAOHIEM
SET STBaoHiem = 1.15 * STBaoHiem,
	STDongDinhKy = 1.15 * STDongDinhKy
WHERE TenLBH = N'Bảo hiểm sức khoẻ nội trú'; 

-- ########## SQL ##########
-- 2a. Liệt kê thông tin mã yêu cầu, mã chi tiết hợp đồng của các yêu cầu 
-- giải quyết bảo hiểm trong năm 2025 và có trạng thái xử lý là ‘Đang xét duyệt’.
SELECT MaYC, MaCTHD
FROM YEUCAUBAOHIEM
WHERE YEAR(NgYeuCau) = 2025 
	AND TrangThai = N'Đang xét duyệt';

-- 2b. Liệt kê thông tin số hợp đồng, mã chi tiết hợp đồng, họ tên khách hàng thụ hưởng 
-- có nghề nghiệp là ‘Giáo viên’ của các hợp đồng có ngày hết hạn trước ngày 31/12/2025. 
SELECT HD.SoHD, MaCTHD, HoTen
FROM HOPDONG HD
JOIN CHITIETHD CT ON CT.SoHD = HD.SoHD
JOIN KHACHHANG KH ON KH.MaKH = CT.MaKHThuHuong
WHERE NgheNghiep = N'Giáo viên'
	AND NgHetHan < '31/12/2025';

-- 2c. Liệt kê mã và họ tên khách hàng thụ hưởng, cùng với các mã giao dịch thanh toán bảo hiểm
-- trong tháng 11/2025 và có phương thức thanh toán là ‘Tiền mặt’ của các chi tiết hợp đồng mà
-- họ đã tham gia (nếu có). 
-- # Cách 1
SELECT MaKHThuHuong, HoTen, MaGD
FROM CHITIETHD CT
JOIN KHACHHANG KH ON KH.MaKH = CT.MaKHThuHuong
LEFT JOIN LSDONGTIEN LS ON LS.MaCTHD = CT.MaCTHD
    AND MONTH(NgDongTien) = 11
    AND YEAR(NgDongTien) = 2025
    AND PhuongThuc = N'Tiền mặt';

-- # Cách 2
SELECT MaKHThuHuong, HoTen, MaGD
FROM KHACHHANG KH
INNER JOIN CHITIETHD CT ON KH.MaKH = CT.MaKHThuHuong
LEFT JOIN (
    SELECT MaGD, MaCTHD
    FROM LSDONGTIEN
    WHERE MONTH(NgDongTien) = 11
        AND YEAR(NgDongTien) = 2025
        AND PhuongThuc = N'Tiền mặt'
) LS ON LS.MaCTHD = CT.MaCTHD;

-- 2d. Liệt kê số hợp đồng, mã và họ tên khách hàng đại diện của các hợp đồng được ký trong
-- năm 2025 đã mua cả hai loại bảo, hiểm có tên là ‘Bệnh hiểm nghèo’ và ‘Tử vong’. 
SELECT HD.SoHD, KH.MaKH, HoTen
FROM HOPDONG HD
JOIN KHACHHANG KH ON KH.MaKH = HD.MaKHDaiDien
JOIN CHITIETHD CT ON CT.SoHD = HD.SoHD
JOIN LOAIBAOHIEM LBH ON LBH.MaLBH = CT.MaLBH
WHERE YEAR(NgKyHD) = 2025
    AND TenLBH = N'Bệnh hiểm nghèo'
INTERSECT
SELECT HD.SoHD, KH.MaKH, HoTen
FROM HOPDONG HD
JOIN KHACHHANG KH ON KH.MaKH = HD.MaKHDaiDien
JOIN CHITIETHD CT ON CT.SoHD = HD.SoHD
JOIN LOAIBAOHIEM LBH ON LBH.MaLBH = CT.MaLBH
WHERE YEAR(NgKyHD) = 2025
    AND TenLBH = N'Tử vong';

-- 2e. Tìm số hợp đồng đã phát sinh các yêu cầu giải quyết bảo hiểm trong năm 2025 và có trạng 
-- thái ‘Đã chi trả’ cho tất cả các loại bảo hiểm có kỳ thanh toán là ‘Hàng tháng’. 
-- # Kiểm tra thông tin database
SELECT CT.MaCTHD, HD.SoHD, KyThanhToan, NgYeuCau, TrangThai
FROM HOPDONG HD
JOIN CHITIETHD CT ON CT.SoHD = HD.SoHD
JOIN YEUCAUBAOHIEM YC ON YC.MaCTHD = CT.MaCTHD
JOIN LOAIBAOHIEM LBH ON LBH.MaLBH = CT.MaLBH
WHERE YEAR(NgYeuCau) = 2025;

SELECT *
FROM LOAIBAOHIEM
WHERE KyThanhToan = N'Hàng tháng';
-- -> Chỉ có HD031 và HD032 là thoả mãn yêu cầu đề bài

-- -> Tìm số hợp đồng đã phát sinh các yêu cầu giải quyết bảo hiểm trong năm 2025 và không tồn tại yêu cầu nào
-- thuộc loại bảo hiểm nào có kỳ thanh toán 'Hàng tháng' mà có trạng thái khác 'Đã chi trả'
SELECT HD.SoHD
FROM HOPDONG HD
WHERE 
    -- phải có ÍT NHẤT 1 yêu cầu năm 2025 cho BH kỳ 'Hàng tháng'
    EXISTS (
        SELECT *
        FROM CHITIETHD CT
        JOIN LOAIBAOHIEM LBH ON LBH.MaLBH = CT.MaLBH
        JOIN YEUCAUBAOHIEM YC ON YC.MaCTHD = CT.MaCTHD
        WHERE YEAR(YC.NgYeuCau) = 2025
            AND LBH.KyThanhToan = N'Hàng tháng'
            AND CT.SoHD = HD.SoHD
    )
    AND
    -- không tồn tại yêu cầu nào trong nhóm có trạng thái khác 'Đã chi trả'
    NOT EXISTS (
        SELECT *
        FROM CHITIETHD CT2
        JOIN YEUCAUBAOHIEM YC2 ON YC2.MaCTHD = CT2.MaCTHD
        JOIN LOAIBAOHIEM LBH2 ON LBH2.MaLBH = CT2.MaLBH
        WHERE YC2.TrangThai <> N'Đã chi trả'
            AND YEAR(YC2.NgYeuCau) = 2025
            AND LBH2.KyThanhToan = N'Hàng tháng'
            AND HD.SoHD = CT2.SoHD
    );

-- 2f. Tìm số hợp đồng có số lần đóng tiền trong năm 2025 bằng hình thức ‘Chuyển khoản’ chiếm 
-- từ 80% trở lên trong tổng số lần đóng tiền trong năm 2025 của hợp đồng đó.
-- # Kiểm tra thông tin database
SELECT HD.SoHD, NgDongTien, PhuongThuc
FROM HOPDONG HD
JOIN CHITIETHD CT ON CT.SoHD = HD.SoHD
JOIN LSDONGTIEN LS ON LS.MaCTHD = CT.MaCTHD 
WHERE PhuongThuc = N'Chuyển khoản'
    AND YEAR(NgDongTien) = 2025;

SELECT HD.SoHD, PhuongThuc
FROM HOPDONG HD
JOIN CHITIETHD CT ON CT.SoHD = HD.SoHD
JOIN LSDONGTIEN LS ON LS.MaCTHD = cT.MaCTHD
WHERE HD.SoHD = 'HD041' OR HD.SoHD = 'HD042';
-- -> Chỉ có HD041 và HD042 thoả mãn

SELECT HD.SoHD
FROM HOPDONG HD
GROUP BY HD.SoHD
HAVING 
    -- Phải tồn tại ít nhất 1 giao dịch trong năm 2025 <-> Tổng số giao dịch trong năm 2025 phải > 0
    (
        SELECT COUNT(*)
        FROM CHITIETHD CT2
        JOIN LSDONGTIEN LS2 ON LS2.MaCTHD = CT2.MaCTHD
        WHERE CT2.SoHD = HD.SoHD
            AND YEAR(LS2.NgDongTien) = 2025
    ) > 0
    AND
    -- Điều kiện ≥ 80%
    (
        SELECT COUNT(*)
        FROM CHITIETHD CT1
        JOIN LSDONGTIEN LS1 ON LS1.MaCTHD = CT1.MaCTHD
        WHERE CT1.SoHD = HD.SoHD
          AND YEAR(LS1.NgDongTien) = 2025
          AND LS1.PhuongThuc = N'Chuyển khoản'
    ) >= 0.8 * ( 
                 SELECT COUNT(*)
                 FROM CHITIETHD CT3
                 JOIN LSDONGTIEN LS3 ON LS3.MaCTHD = CT3.MaCTHD
                 WHERE CT3.SoHD = HD.SoHD
                    AND YEAR(LS3.NgDongTien) = 2025
               );